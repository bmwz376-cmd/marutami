{% extends "base.html" %}

{% block title %}è¬›å¸«ãƒ¢ãƒ¼ãƒ‰ - æ•™æãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ {% endblock %}

{% block content %}
<div class="viewer-container">
    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼: ã‚µãƒ ãƒã‚¤ãƒ« -->
    <div class="sidebar">
        <div class="p-4 bg-white border-b">
            <h2 class="font-bold text-lg" id="material-title">èª­ã¿è¾¼ã¿ä¸­...</h2>
            <p class="text-sm text-gray-600"><span id="total-pages">0</span>ãƒšãƒ¼ã‚¸</p>
        </div>
        
        <div id="thumbnails-container" class="p-4 space-y-2">
            <!-- ã‚µãƒ ãƒã‚¤ãƒ«å‹•çš„ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- ä¸­å¤®: ãƒšãƒ¼ã‚¸è¡¨ç¤º -->
    <div class="main-viewer">
        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="toolbar">
            <div class="sync-indicator active" id="sync-indicator">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="5"/>
                </svg>
                <span>åŒæœŸä¸­</span>
            </div>
            
            <a href="/feedback?room_id={{ room_id }}" class="btn btn-secondary ml-4">
                ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            </a>
            
            <a href="/feedback/analytics" class="btn btn-secondary ml-2" target="_blank">
                ğŸ“Š é›†è¨ˆ
            </a>
            
            <div class="flex-1"></div>
            
            <button class="btn btn-secondary" onclick="viewer.zoomOut()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
                </svg>
            </button>
            
            <span id="zoom-level">100%</span>
            
            <button class="btn btn-secondary" onclick="viewer.zoomIn()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                </svg>
            </button>
            
            <button class="btn btn-secondary" onclick="viewer.fitToScreen()">
                ç”»é¢ã«åˆã‚ã›ã‚‹
            </button>
            
            <div class="flex-1"></div>
            
            <button class="btn btn-secondary" onclick="viewer.prevPage()" id="prev-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            
            <span class="font-medium">
                <span id="current-page">1</span> / <span id="total-pages-display">1</span>
            </span>
            
            <button class="btn btn-secondary" onclick="viewer.nextPage()" id="next-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="page-canvas-container" id="page-container">
            <img id="page-image" class="page-image" alt="ãƒšãƒ¼ã‚¸ç”»åƒ">
            <svg id="annotation-layer" class="annotation-layer"></svg>
        </div>
    </div>
    
    <!-- å³ãƒ‘ãƒãƒ«: è¬›å¸«ãƒ„ãƒ¼ãƒ« -->
    <div class="right-panel">
        <div class="p-4">
            <h2 class="text-xl font-bold mb-4">è¬›å¸«ãƒ„ãƒ¼ãƒ«</h2>
            
            <!-- ã‚¿ãƒ– -->
            <div class="flex border-b mb-4">
                <button class="tab-btn active" data-tab="control">åˆ¶å¾¡</button>
                <button class="tab-btn" data-tab="annotation">æ³¨é‡ˆ</button>
                <button class="tab-btn" data-tab="notes">ãƒãƒ¼ãƒˆ</button>
                <button class="tab-btn" data-tab="points">é‡è¦ãƒã‚¤ãƒ³ãƒˆ</button>
            </div>
            
            <!-- åˆ¶å¾¡ã‚¿ãƒ– -->
            <div class="tab-content active" id="tab-control">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">åŒæœŸåˆ¶å¾¡</h3>
                        <button id="sync-toggle-btn" onclick="instructor.toggleSync()" 
                            class="w-full btn btn-primary">
                            åŒæœŸã‚’åœæ­¢
                        </button>
                        <p class="text-sm text-gray-600 mt-2">
                            ONã®é–“ã€å—è¬›è€…ã¯è¬›å¸«ã¨åŒã˜ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">å‚åŠ è€… (<span id="participant-count">0</span>äºº)</h3>
                        <div id="participants-list" class="space-y-2 text-sm">
                            <!-- å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ³¨é‡ˆã‚¿ãƒ– -->
            <div class="tab-content" id="tab-annotation">
                <div class="space-y-3">
                    <button onclick="instructor.setAnnotationMode('pin')" 
                        class="w-full btn btn-primary annotation-mode-btn" data-mode="pin">
                        ğŸ“ ãƒ”ãƒ³
                    </button>
                    
                    <button onclick="instructor.setAnnotationMode('circle')" 
                        class="w-full btn btn-secondary annotation-mode-btn" data-mode="circle">
                        â­• ä¸¸
                    </button>
                    
                    <button onclick="instructor.setAnnotationMode('rect')" 
                        class="w-full btn btn-secondary annotation-mode-btn" data-mode="rect">
                        â–­ å››è§’
                    </button>
                    
                    <button onclick="instructor.setAnnotationMode('pen')" 
                        class="w-full btn btn-secondary annotation-mode-btn" data-mode="pen">
                        âœï¸ ãƒšãƒ³
                    </button>
                    
                    <button onclick="instructor.setAnnotationMode('laser')" 
                        class="w-full btn btn-secondary annotation-mode-btn" data-mode="laser">
                        ğŸ”´ ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ã‚¿
                    </button>
                    
                    <hr>
                    
                    <button onclick="instructor.clearAnnotations()" 
                        class="w-full btn btn-danger">
                        æ³¨é‡ˆã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
            
            <!-- ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div class="tab-content" id="tab-notes">
                <div id="instructor-notes-content">
                    <p class="text-gray-500 text-sm">ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            
            <!-- é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚¿ãƒ– -->
            <div class="tab-content" id="tab-points">
                <div class="space-y-3">
                    <button onclick="instructor.showImportantCard('é…ç­‹æ¤œæŸ»ã®è¦ç‚¹', ['æ§‹é€ å›³ã®æŠŠæ¡', 'å®šç€ãƒ»é‡ã­ç¶™æ‰‹ã®ç¢ºèª', 'ã‹ã¶ã‚Šã®ç¢ºèª', 'å¸¯ç­‹ãƒ»ã‚ã°ã‚‰ç­‹ã®é…ç½®', 'é‰„ç­‹ã®æ¸…æƒçŠ¶æ…‹'])" 
                        class="w-full btn btn-primary text-left">
                        é…ç­‹æ¤œæŸ»ã®è¦ç‚¹
                    </button>
                    
                    <button onclick="instructor.showImportantCard('ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆæ‰“è¨­ç¢ºèª', ['é…åˆè¨ˆç”»ã®ç¢ºèª', 'è·å¸ã—æ™‚ã®æ¤œæŸ»', 'ã‚¹ãƒ©ãƒ³ãƒ—è©¦é¨“', 'æ‰“è¨­é€Ÿåº¦ã®ç®¡ç†', 'ç· å›ºã‚ã®ç¢ºèª'])" 
                        class="w-full btn btn-primary text-left">
                        ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆæ‰“è¨­ç¢ºèª
                    </button>
                    
                    <button onclick="instructor.showImportantCard('é¤Šç”Ÿç®¡ç†', ['åˆæœŸé¤Šç”ŸæœŸé–“', 'æ¸©åº¦ç®¡ç†', 'æ¹¿æ½¤é¤Šç”Ÿã®æ–¹æ³•', 'å‹æ å­˜ç½®æœŸé–“', 'å¼·åº¦ç¢ºèª'])" 
                        class="w-full btn btn-primary text-left">
                        é¤Šç”Ÿç®¡ç†
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="important-modal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4" id="important-title"></h2>
        <ul class="space-y-3" id="important-points">
            <!-- å‹•çš„ç”Ÿæˆ -->
        </ul>
        <button onclick="instructor.hideImportantCard()" class="mt-6 w-full btn btn-primary">
            æ¬¡ã¸
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/viewer.js"></script>
<script src="/static/js/sync.js"></script>
<script src="/static/js/instructor.js"></script>
<script>
    const roomId = "{{ room_id }}";
    const role = "instructor";
    
    // ã‚¿ãƒ–åˆ‡æ›¿
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        });
    });
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
        await sync.init(roomId, role);
        await instructor.init(roomId);
    });
</script>

<style>
    .tab-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-btn.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .annotation-mode-btn.active {
        background: #0056b3;
    }
</style>
{% endblock %}
