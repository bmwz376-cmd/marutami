{% extends "base.html" %}

{% block title %}ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é›†è¨ˆ - æ•™æãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ {% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é›†è¨ˆ</h1>
                <p class="text-gray-600 mt-2">ãƒ†ã‚¹ãƒˆè¬›ç¾©ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æ</p>
            </div>
            <a href="/" class="btn btn-secondary">æ•™æä¸€è¦§ã¸</a>
        </div>
    </header>
    
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-gray-500">ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°</h3>
                <p class="text-3xl font-bold mt-2" id="total-count">-</p>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-gray-500">è¬›å¸«</h3>
                <p class="text-3xl font-bold mt-2" id="instructor-count">-</p>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-gray-500">å—è¬›è€…</h3>
                <p class="text-3xl font-bold mt-2" id="student-count">-</p>
            </div>
        </div>
        
        <!-- å¹³å‡è©•ä¾¡ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6">å¹³å‡è©•ä¾¡ï¼ˆ1-5ï¼‰</h2>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">ãƒšãƒ¼ã‚¸åŒæœŸã®é€Ÿåº¦</span>
                        <span class="font-bold text-blue-600" id="avg-sync">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-full" id="bar-sync" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">æ³¨é‡ˆãƒ„ãƒ¼ãƒ«ã®ä½¿ã„ã‚„ã™ã•</span>
                        <span class="font-bold text-green-600" id="avg-annotation">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-green-600 h-3 rounded-full" id="bar-annotation" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">ç”¨èªãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®æœ‰ç”¨æ€§</span>
                        <span class="font-bold text-purple-600" id="avg-metadata">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-purple-600 h-3 rounded-full" id="bar-metadata" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">UIã®åˆ†ã‹ã‚Šã‚„ã™ã•</span>
                        <span class="font-bold text-yellow-600" id="avg-ui">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-yellow-600 h-3 rounded-full" id="bar-ui" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium text-lg">ç·åˆè©•ä¾¡</span>
                        <span class="font-bold text-red-600 text-lg" id="avg-overall">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-600 h-4 rounded-full" id="bar-overall" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚ˆãã‚ã‚‹å•é¡Œ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6">ã‚ˆãã‚ã‚‹æŠ€è¡“çš„å•é¡Œï¼ˆTop 5ï¼‰</h2>
            
            <div id="common-issues" class="space-y-3">
                <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
        
        <!-- å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-6">å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸€è¦§</h2>
            
            <div id="feedback-list" class="space-y-4">
                <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadStatistics() {
        try {
            const response = await fetch('/api/feedback/statistics');
            const stats = await response.json();
            
            // ã‚µãƒãƒªãƒ¼
            document.getElementById('total-count').textContent = stats.total_count;
            document.getElementById('instructor-count').textContent = stats.instructor_count;
            document.getElementById('student-count').textContent = stats.student_count;
            
            // å¹³å‡è©•ä¾¡
            const ratings = stats.average_ratings;
            
            updateRating('sync', ratings.sync_speed);
            updateRating('annotation', ratings.annotation);
            updateRating('metadata', ratings.metadata);
            updateRating('ui', ratings.ui);
            updateRating('overall', ratings.overall);
            
            // ã‚ˆãã‚ã‚‹å•é¡Œ
            const issuesEl = document.getElementById('common-issues');
            if (stats.common_issues && stats.common_issues.length > 0) {
                issuesEl.innerHTML = stats.common_issues.map(([issue, count]) => `
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                        <span class="font-medium">${issue}</span>
                        <span class="px-3 py-1 bg-red-600 text-white rounded-full text-sm">
                            ${count}ä»¶
                        </span>
                    </div>
                `).join('');
            } else {
                issuesEl.innerHTML = '<p class="text-gray-500">æŠ€è¡“çš„å•é¡Œã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
        } catch (error) {
            console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    async function loadFeedbacks() {
        try {
            const response = await fetch('/api/feedback');
            const feedbacks = await response.json();
            
            const listEl = document.getElementById('feedback-list');
            
            if (feedbacks.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            listEl.innerHTML = feedbacks.map(fb => `
                <div class="border rounded-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="font-bold text-lg">${fb.user_name}</span>
                            <span class="ml-3 px-3 py-1 text-sm rounded-full ${
                                fb.user_role === 'instructor' 
                                    ? 'bg-blue-100 text-blue-800' 
                                    : 'bg-green-100 text-green-800'
                            }">
                                ${fb.user_role === 'instructor' ? 'è¬›å¸«' : 'å—è¬›è€…'}
                            </span>
                        </div>
                        <span class="text-sm text-gray-500">
                            ${new Date(fb.timestamp).toLocaleString('ja-JP')}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <div class="text-xs text-gray-500">åŒæœŸé€Ÿåº¦</div>
                            <div class="text-2xl font-bold">${fb.rating_sync_speed}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">æ³¨é‡ˆ</div>
                            <div class="text-2xl font-bold">${fb.rating_annotation}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</div>
                            <div class="text-2xl font-bold">${fb.rating_metadata}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">UI</div>
                            <div class="text-2xl font-bold">${fb.rating_ui}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 font-bold">ç·åˆ</div>
                            <div class="text-2xl font-bold text-red-600">${fb.rating_overall}</div>
                        </div>
                    </div>
                    
                    ${fb.comment_good ? `
                        <div class="mb-3">
                            <div class="text-sm font-medium text-green-700 mb-1">âœ“ è‰¯ã‹ã£ãŸç‚¹</div>
                            <div class="text-sm text-gray-700 bg-green-50 p-3 rounded">${fb.comment_good}</div>
                        </div>
                    ` : ''}
                    
                    ${fb.comment_bad ? `
                        <div class="mb-3">
                            <div class="text-sm font-medium text-red-700 mb-1">âœ— æ”¹å–„ãŒå¿…è¦ãªç‚¹</div>
                            <div class="text-sm text-gray-700 bg-red-50 p-3 rounded">${fb.comment_bad}</div>
                        </div>
                    ` : ''}
                    
                    ${fb.comment_feature ? `
                        <div class="mb-3">
                            <div class="text-sm font-medium text-blue-700 mb-1">ğŸ’¡ è¿½åŠ ã—ã¦ã»ã—ã„æ©Ÿèƒ½</div>
                            <div class="text-sm text-gray-700 bg-blue-50 p-3 rounded">${fb.comment_feature}</div>
                        </div>
                    ` : ''}
                    
                    ${fb.technical_issues && fb.technical_issues.length > 0 ? `
                        <div>
                            <div class="text-sm font-medium text-orange-700 mb-1">âš ï¸ æŠ€è¡“çš„å•é¡Œ</div>
                            <div class="flex flex-wrap gap-2">
                                ${fb.technical_issues.map(issue => `
                                    <span class="px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">${issue}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
        } catch (error) {
            console.error('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    function updateRating(key, value) {
        const avgEl = document.getElementById(`avg-${key}`);
        const barEl = document.getElementById(`bar-${key}`);
        
        avgEl.textContent = value.toFixed(2);
        barEl.style.width = `${(value / 5) * 100}%`;
    }
    
    // åˆæœŸèª­ã¿è¾¼ã¿
    window.addEventListener('load', () => {
        loadStatistics();
        loadFeedbacks();
    });
    
    // 30ç§’ã”ã¨ã«æ›´æ–°
    setInterval(() => {
        loadStatistics();
        loadFeedbacks();
    }, 30000);
</script>
{% endblock %}
