<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒãƒƒã‚° - è¬›å¸«ç”»é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h2 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        #console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è¬›å¸«ç”»é¢ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="debug-section">
        <h2>1. åŸºæœ¬æƒ…å ±</h2>
        <div class="status info">
            <strong>ãƒ«ãƒ¼ãƒ ID:</strong> <span id="room-id">{{ room_id }}</span>
        </div>
        <div class="status info">
            <strong>æ•™æID:</strong> <span id="material-id">{{ material_id }}</span>
        </div>
    </div>
    
    <div class="debug-section">
        <h2>2. JavaScriptèª­ã¿è¾¼ã¿çŠ¶æ…‹</h2>
        <div id="js-status"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. APIãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testMaterialAPI()">æ•™æAPIã‚’ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testRoomAPI()">ãƒ«ãƒ¼ãƒ APIã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="api-status"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testViewerInit()">Viewerã‚’åˆæœŸåŒ–</button>
        <button onclick="testAnnotationLayer()">AnnotationLayerã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="init-status"></div>
    </div>
    
    <div class="debug-section">
        <h2>5. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
        <button onclick="clearConsole()">ã‚¯ãƒªã‚¢</button>
        <div id="console-output"></div>
    </div>

    <script src="/static/js/viewer.js"></script>
    <script src="/static/js/annotations.js"></script>
    <script src="/static/js/sync.js"></script>
    <script src="/static/js/instructor.js"></script>
    
    <script>
        const roomId = "{{ room_id }}";
        const materialId = "{{ material_id }}";
        
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(type, ...args) {
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'âœ“';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', ...args);
        };
        
        function clearConsole() {
            consoleOutput.textContent = '';
        }
        
        // JavaScriptèª­ã¿è¾¼ã¿çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkJSStatus() {
            const status = document.getElementById('js-status');
            let html = '';
            
            const checks = [
                { name: 'Viewer', obj: typeof Viewer !== 'undefined' },
                { name: 'AnnotationLayer', obj: typeof AnnotationLayer !== 'undefined' },
                { name: 'SyncManager', obj: typeof SyncManager !== 'undefined' },
                { name: 'InstructorController', obj: typeof InstructorController !== 'undefined' },
                { name: 'viewer (instance)', obj: typeof viewer !== 'undefined' },
                { name: 'instructor (instance)', obj: typeof instructor !== 'undefined' },
                { name: 'sync (instance)', obj: typeof sync !== 'undefined' }
            ];
            
            checks.forEach(check => {
                const className = check.obj ? 'success' : 'error';
                const icon = check.obj ? 'âœ…' : 'âŒ';
                html += `<div class="status ${className}">${icon} ${check.name}: ${check.obj ? 'OK' : 'NG'}</div>`;
            });
            
            status.innerHTML = html;
        }
        
        async function testMaterialAPI() {
            const status = document.getElementById('api-status');
            console.log('æ•™æAPIãƒ†ã‚¹ãƒˆé–‹å§‹:', materialId);
            
            try {
                const response = await fetch(`/api/materials/${materialId}`);
                const data = await response.json();
                console.log('æ•™æAPIæˆåŠŸ:', data);
                status.innerHTML = `<div class="status success">âœ… æ•™æAPIæˆåŠŸ: ${data.title}, ${data.total_pages}ãƒšãƒ¼ã‚¸</div>`;
            } catch (error) {
                console.error('æ•™æAPIã‚¨ãƒ©ãƒ¼:', error);
                status.innerHTML = `<div class="status error">âŒ æ•™æAPIã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        async function testRoomAPI() {
            const status = document.getElementById('api-status');
            console.log('ãƒ«ãƒ¼ãƒ APIãƒ†ã‚¹ãƒˆé–‹å§‹:', roomId);
            
            try {
                const response = await fetch(`/api/rooms/${roomId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('ãƒ«ãƒ¼ãƒ APIæˆåŠŸ:', data);
                    status.innerHTML += `<div class="status success">âœ… ãƒ«ãƒ¼ãƒ APIæˆåŠŸ: ${JSON.stringify(data)}</div>`;
                } else {
                    console.warn('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    status.innerHTML += `<div class="status error">âš ï¸ ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)</div>`;
                }
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ APIã‚¨ãƒ©ãƒ¼:', error);
                status.innerHTML += `<div class="status error">âŒ ãƒ«ãƒ¼ãƒ APIã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        async function testViewerInit() {
            const status = document.getElementById('init-status');
            console.log('VieweråˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ:', materialId);
            
            try {
                if (typeof viewer === 'undefined') {
                    throw new Error('viewerãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                await viewer.loadMaterial(materialId);
                console.log('VieweråˆæœŸåŒ–æˆåŠŸ');
                status.innerHTML = `<div class="status success">âœ… VieweråˆæœŸåŒ–æˆåŠŸ</div>`;
            } catch (error) {
                console.error('VieweråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                status.innerHTML = `<div class="status error">âŒ VieweråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        function testAnnotationLayer() {
            const status = document.getElementById('init-status');
            console.log('AnnotationLayerãƒ†ã‚¹ãƒˆ');
            
            try {
                const layer = new AnnotationLayer('test-layer');
                console.log('AnnotationLayerä½œæˆæˆåŠŸ:', layer);
                status.innerHTML += `<div class="status success">âœ… AnnotationLayerä½œæˆæˆåŠŸ</div>`;
            } catch (error) {
                console.error('AnnotationLayerã‚¨ãƒ©ãƒ¼:', error);
                status.innerHTML += `<div class="status error">âŒ AnnotationLayerã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            console.log('=== ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èµ·å‹• ===');
            console.log('roomId:', roomId);
            console.log('materialId:', materialId);
            checkJSStatus();
        });
    </script>
</body>
</html>
