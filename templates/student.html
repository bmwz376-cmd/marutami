{% extends "base.html" %}

{% block title %}å—è¬›è€…ãƒ¢ãƒ¼ãƒ‰ - æ•™æãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ {% endblock %}

{% block content %}
<div class="viewer-container">
    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼: ã‚µãƒ ãƒã‚¤ãƒ« -->
    <div class="sidebar">
        <div class="p-4 bg-white border-b">
            <h2 class="font-bold text-lg" id="material-title">èª­ã¿è¾¼ã¿ä¸­...</h2>
            <p class="text-sm text-gray-600"><span id="total-pages">0</span>ãƒšãƒ¼ã‚¸</p>
        </div>
        
        <div id="thumbnails-container" class="p-4 space-y-2">
            <!-- ã‚µãƒ ãƒã‚¤ãƒ«å‹•çš„ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- ä¸­å¤®: ãƒšãƒ¼ã‚¸è¡¨ç¤º -->
    <div class="main-viewer">
        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="toolbar">
            <div class="sync-indicator active" id="sync-indicator">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="5"/>
                </svg>
                <span>è¬›å¸«ã¨åŒæœŸä¸­</span>
            </div>
            
            <a href="/feedback?room_id={{ room_id }}" class="btn btn-secondary ml-4">
                ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            </a>
            
            <div class="flex-1"></div>
            
            <button class="btn btn-secondary" onclick="viewer.zoomOut()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
                </svg>
            </button>
            
            <span id="zoom-level">100%</span>
            
            <button class="btn btn-secondary" onclick="viewer.zoomIn()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                </svg>
            </button>
            
            <button class="btn btn-secondary" onclick="viewer.fitToScreen()">
                ç”»é¢ã«åˆã‚ã›ã‚‹
            </button>
            
            <div class="flex-1"></div>
            
            <span class="font-medium">
                <span id="current-page">1</span> / <span id="total-pages-display">1</span>
            </span>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="page-canvas-container" id="page-container">
            <img id="page-image" class="page-image" alt="ãƒšãƒ¼ã‚¸ç”»åƒ">
            <svg id="annotation-layer" class="annotation-layer"></svg>
        </div>
    </div>
    
    <!-- å³ãƒ‘ãƒãƒ«: å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹ -->
    <div class="right-panel">
        <div class="p-4">
            <h2 class="text-xl font-bold mb-4">å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹</h2>
            
            <!-- ã‚¿ãƒ– -->
            <div class="flex border-b mb-4">
                <button class="tab-btn active" data-tab="glossary">ç”¨èª</button>
                <button class="tab-btn" data-tab="checklist">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
                <button class="tab-btn" data-tab="notes">ãƒãƒ¼ãƒˆ</button>
            </div>
            
            <!-- ç”¨èªã‚¿ãƒ– -->
            <div class="tab-content active" id="tab-glossary">
                <div id="glossary-content">
                    <p class="text-gray-500 text-sm">ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç”¨èªãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            
            <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
            <div class="tab-content" id="tab-checklist">
                <div id="checklist-content">
                    <p class="text-gray-500 text-sm">ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            
            <!-- ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div class="tab-content" id="tab-notes">
                <div id="notes-content">
                    <p class="text-gray-500 text-sm">è¬›å¸«ãŒãƒãƒ¼ãƒˆã‚’å…¬é–‹ã—ã¦ã„ã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="important-modal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4" id="important-title"></h2>
        <ul class="space-y-3" id="important-points">
            <!-- å‹•çš„ç”Ÿæˆ -->
        </ul>
        <p class="text-sm text-gray-500 mt-6 text-center">
            è¬›å¸«ãŒæ¬¡ã®ãƒšãƒ¼ã‚¸ã«é€²ã‚€ã¾ã§ãŠå¾…ã¡ãã ã•ã„
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/viewer.js"></script>
<script src="/static/js/sync.js"></script>
<script>
    const roomId = "{{ room_id }}";
    const materialId = "{{ material_id }}";
    const role = "student";
    
    // ã‚¿ãƒ–åˆ‡æ›¿
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        });
    });
    
    // å—è¬›è€…ç”¨ã®ãƒšãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    function updatePageMetadata(pageData) {
        // ç”¨èª
        const glossaryEl = document.getElementById('glossary-content');
        if (pageData.glossary && pageData.glossary.length > 0) {
            glossaryEl.innerHTML = pageData.glossary.map(term => `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-blue-600">${term.term}</h4>
                    <p class="text-sm text-gray-700 mt-1">${term.definition}</p>
                </div>
            `).join('');
        } else {
            glossaryEl.innerHTML = '<p class="text-gray-500 text-sm">ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ç”¨èªãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
        // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        const checklistEl = document.getElementById('checklist-content');
        if (pageData.checklist && pageData.checklist.length > 0) {
            checklistEl.innerHTML = pageData.checklist.map((item, idx) => `
                <div class="mb-3">
                    <label class="flex items-start gap-2 cursor-pointer">
                        <input type="checkbox" class="mt-1" data-idx="${idx}">
                        <span class="text-sm">${item.text}</span>
                    </label>
                    ${item.note ? `<p class="text-xs text-red-600 ml-6 mt-1">${item.note}</p>` : ''}
                </div>
            `).join('');
        } else {
            checklistEl.innerHTML = '<p class="text-gray-500 text-sm">ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
    }
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
        console.log('å—è¬›è€…ç”»é¢åˆæœŸåŒ– - roomId:', roomId, 'materialId:', materialId);
        
        // æ•™æã‚’èª­ã¿è¾¼ã¿
        if (materialId && materialId !== 'None') {
            console.log('æ•™æèª­ã¿è¾¼ã¿:', materialId);
            await viewer.loadMaterial(materialId);
        } else {
            console.warn('materialIdãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
        await sync.init(roomId, role, {
            onPageChange: (pageNumber) => {
                const currentPage = viewer.materialData.pages.find(p => p.page_number === pageNumber);
                if (currentPage) {
                    updatePageMetadata(currentPage);
                }
            }
        });
    });
</script>

<style>
    .tab-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-btn.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}
